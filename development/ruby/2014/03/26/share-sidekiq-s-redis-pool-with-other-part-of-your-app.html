<!DOCTYPE html>
<html class="nojs">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Share Sidekiq's redis pool with other part of your app * ixti's personal scratchpad</title>
    <meta name="description" content="Personal blog of Aleksey V Zapparov AKA ixti">
    <meta name="viewport" content="width=device-width">
    <meta name="generator" content="jekyll">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans+Condensed:300:latin,cyrillic|Open+Sans::latin">
    <link rel="stylesheet" href="/assets/app-7ec9dff94a465c2ed5d6865f8d106d58.css">
    <script src="/assets/app-a5eac6a6dcd80a63d9a7222d0d345b93.js"></script>
  </head>
  <body class="light">
    <header id="header">
      <h1><a href="/"><span>personal scratchpad</span></a></h1>
      <div id="top-navigation" class="navbar">
        <ul>
          <li><a href="https://github.com/ixti/ixti.github.com">Sources</a></li>
          <li id="js-theme-switcher"><a href="#">Switch Theme</a></li>
        </ul>
        <ul>
          <li><a href="https://github.com/ixti">GitHub</a></li>
          <li><a href="http://es.linkedin.com/in/zapparov">LinkedIn</a></li>
          <li><a href="https://twitter.com/zapparov">Twitter</a></li>
          <li><a href="http://feeds.feedburner.com/ixti">RSS</a></li>
        </ul>
      </div>
    </header>

    <article class="post">
  <header>
    <h2>Share Sidekiq's redis pool with other part of your app</h2>
    
    <ul class="post-info">
  <li>Date: 26 Mar 2014</li>

  
    <li>Category: <a href="/categories/development/ruby.html">development/ruby</a></li>
  

  
    <li>Tagged with: <a href="/tags/ruby.html">ruby</a>, <a href="/tags/rails.html">rails</a>, <a href="/tags/redis.html">redis</a>, <a href="/tags/sidekiq.html">sidekiq</a>, and <a href="/tags/semaphore.html">semaphore</a></li>
  
</ul>

  </header>

  <p>If you are running <a href="https://github.com/mperham/sidekiq/">Sidekiq</a>, then, most likely you would like to share it&rsquo;s
redis connection with other bits of your application. For example, you want to
implement a throttler for some Rails action, or you want to use some gem, that
needs redis, e.g. <a href="https://github.com/dv/redis-semaphore/">redis-semaphore</a>. Well, it&rsquo;s easier than it might sound&hellip;</p>

<p>This snippet was extrcated from one of Rails applications I have honor to work
on, but it can be used in any other application. There&rsquo;s only one bit that
relies on Rails: <code>MyApplication::Redis#url</code> - it uses <code>Rails.root</code>.</p>

<p>So you should put this snippet somewhere in your app. On Rails, a good
choice will be <code>config/initializers/00_redis.rb</code>.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Redis</span>
    <span class="k">class</span> <span class="nc">Pool</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">ConnectionPool</span>
      <span class="kp">attr_accessor</span> <span class="ss">:namespace</span>

      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
        <span class="k">super</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">delete</span> <span class="ss">:pool</span><span class="p">)</span> <span class="p">{</span> <span class="no">Redis</span><span class="o">.</span><span class="n">new</span> <span class="n">options</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">with_namespace</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
        <span class="nb">clone</span><span class="o">.</span><span class="n">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">o</span><span class="o">|</span> <span class="n">o</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">ns</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">checkout</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="k">super</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">conn</span> <span class="o">&amp;&amp;</span> <span class="n">namespace</span>
          <span class="k">return</span> <span class="o">::</span><span class="no">Redis</span><span class="o">::</span><span class="no">Namespace</span><span class="o">.</span><span class="n">new</span> <span class="n">namespace</span><span class="p">,</span> <span class="ss">:redis</span> <span class="o">=&gt;</span> <span class="n">conn</span>
        <span class="k">end</span>

        <span class="n">conn</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">wrap</span>
        <span class="no">Wraper</span><span class="o">.</span><span class="n">new</span> <span class="nb">self</span>
      <span class="k">end</span>

      <span class="k">class</span> <span class="nc">Wrapper</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">ConnectionPool</span><span class="o">::</span><span class="no">Wrapper</span>
        <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
          <span class="vi">@pool</span> <span class="o">=</span> <span class="n">pool</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">pool</span>
      <span class="vi">@pool</span> <span class="o">||=</span> <span class="no">Pool</span><span class="o">.</span><span class="n">new</span> <span class="n">config</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">config</span>
      <span class="p">{</span>
        <span class="ss">:url</span>      <span class="o">=&gt;</span> <span class="n">url</span><span class="p">,</span>
        <span class="ss">:driver</span>   <span class="o">=&gt;</span> <span class="ss">:hiredis</span><span class="p">,</span>
        <span class="ss">:timeout</span>  <span class="o">=&gt;</span> <span class="mi">10</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span>
        <span class="ss">:pool</span>     <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="n">pool_size</span> <span class="p">}</span>
      <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">pool_size</span>
      <span class="k">case</span>
      <span class="k">when</span> <span class="o">::</span><span class="no">Sidekiq</span><span class="o">.</span><span class="n">server?</span> <span class="k">then</span> <span class="no">Sidekiq</span><span class="o">.</span><span class="n">options</span><span class="o">[</span><span class="ss">:concurrency</span><span class="o">]</span> <span class="o">+</span> <span class="mi">2</span>
      <span class="k">else</span>                        <span class="mi">5</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">url</span>
      <span class="vi">@url</span> <span class="o">||=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;redis.yml&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
        <span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="p">)</span> <span class="p">{</span> <span class="nb">fail</span> <span class="s2">&quot;No Redis URL given in config/redis.yml&quot;</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">redis</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="k">return</span> <span class="no">Redis</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">wrap</span> <span class="k">unless</span> <span class="nb">block_given?</span>
    <span class="no">Redis</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Now, it&rsquo;s time to configure Sidekiq. It&rsquo;s pretty trivial, instead of passing
redis options, we will pass it a <code>ConnectionPool</code> instance:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Sidekiq</span><span class="o">.</span><span class="n">configure_client</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="o">::</span><span class="no">MyApplication</span><span class="o">::</span><span class="no">Redis</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">with_namespace</span> <span class="s2">&quot;sidekiq&quot;</span>
<span class="k">end</span>

<span class="no">Sidekiq</span><span class="o">.</span><span class="n">configure_server</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="o">::</span><span class="no">MyApplication</span><span class="o">::</span><span class="no">Redis</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">with_namespace</span> <span class="s2">&quot;sidekiq&quot;</span>
<span class="k">end</span>
</code></pre></div>
<p>And finally, with our <code>Pool::Wrapper</code> we can use it in redis-semaphore:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">semaphore</span> <span class="o">=</span> <span class="no">Redis</span><span class="o">::</span><span class="no">Semaphore</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">:redis</span> <span class="o">=&gt;</span> <span class="no">MyApplication</span><span class="o">.</span><span class="n">redis</span><span class="p">)</span>
</code></pre></div>
</article>



<!-- DISQUS -->
<div id="disqus_thread"></div>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


    <ul id="bottom-navigation" class="navbar">
      
        <li><a href="/archives/2014.html">2014</a></li>
      
        <li><a href="/archives/2013.html">2013</a></li>
      
        <li><a href="/archives/2012.html">2012</a></li>
      
        <li><a href="/archives/2011.html">2011</a></li>
      
        <li><a href="/archives/2010.html">2010</a></li>
      
    </ul>

    <footer id="footer" role="contentinfo">
      kindly generated by <a href="https://github.com/mojombo/jekyll">Jekyll</a>
      ~
      crafted by <a href="http://ixti.net">ixti</a>
      using <a href="http://gimp.org/">Gimp</a>
      and <a href="http://www.vim.org/">Vim</a>
      ~
      copyright &copy; 2010 Aleksey V Zapparov AKA ixti
    </footer>
  </body>
</html>
